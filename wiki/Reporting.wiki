#summary A description of the reporting facilities within Indicia
#labels Phase-Deploy

= Introduction =

Indicia uses a subset of the format used in Recorder to allow custom defined reporting. This document outlines how to define a report and how to use the Indicia reporting services to run it, either from the core module or from a site module.

= Details =

== Report Format ==

At the moment, reports must be defined in an XML document similar to that used in Recorder. No formal schema exists, but the structure is sufficiently simple that an example should suffice to allow you to write reports easily. If you wish to expand the capability to support other formats, you may do so by implementing the ReportReader interface and defining a report format in the ReportEngine class. Details of this are however beyond the scope of this document.

An XML defined report might look something like this:

{{{
<?xml version="1.0" encoding="UTF-8"?>

<report title="Recent Activity" description="Lists recent activity broken down by survey.">
      <query>
      SELECT su.title as survey, w.title as website, COUNT(*) as count FROM websites w 
      JOIN occurrences o ON o.website_id = w.id
      JOIN samples s ON o.sample_id = s.id
      JOIN surveys su ON s.survey_id = su.id
      WHERE o.created_on > '#date#%'::date
      GROUP BY survey, website
      </query>
      <order_bys>
            <order_by>website ASC</order_by>
	    <order_by>survey ASC</order_by>
      </order_bys>
      <params>
	    <param name='date' display='Since: ' description='Show activity since:' datatype='date' />
      </params>
      <columns>
            <column name="survey" display="Survey Name" style="color: #ff0000;"/>
            <column name="website" display="Website Name" />
            <column name="count" display="Total no. of Occurrences" />
      </columns>
</report>
}}}

This report will return details on recent observation activity, broken down by website and survey. It takes one parameter, `date`, which sets the point after which activity should be considered - for example, setting `date` one month ago would give a report on activity within the past month.

We briefly run through the various elements within this report and provide guides as to their usage:

{{{ 
<report title="Recent Activity" description="Lists recent activity broken down by survey."> 
}}} 

The report element is the root of the document, and accepts two attributes, title and description, both self-explanatory.

{{{      
<query>
      SELECT su.title as survey, w.title as website, COUNT(*) as count FROM websites w 
      JOIN occurrences o ON o.website_id = w.id
      JOIN samples s ON o.sample_id = s.id
      JOIN surveys su ON s.survey_id = su.id
      WHERE o.created_on > '#date#%'::date
      GROUP BY survey, website
</query>
}}}

The query element is again self-explanatory for the most part, with only the note that report parameters (see below) are specified in the format `/#([a-z0-9_]+)#%/i` (where /i denotes that we are using case-insensitive patterns - thus, `Date` would equally be a valid parameter name).

{{{
      <order_bys>
            <order_by>website ASC</order_by>
	    <order_by>survey ASC</order_by>
      </order_bys>
}}}

The order_bys are appended to the end of the query in the obvious way, and can be permuted to change the ordering.

{{{
      <params>
	    <param name='date' display='Since: ' description='Show activity since:' datatype='date' />
      </params>
}}}

Parameters may be specified to allow the report requester to specify information at compile-time. In the example above, the report requester will receive a prompt to enter a date, which will then be used in the query. Parameters take four attributes and have no child elements:

  * `name` should match the name given in the query, excluding the # and #% terminators. Thus, in the example above, the parameter name 'date' matches the pattern '#date#%' in the query.
  * `display` is the text used to label the parameter in the parameter request screen.
  * `description` gives a further description, and may be used in describing reports/parameters.
  * `datatype` is used in determining the type of control to show when requesting the parameter. Currently, the core module report interface supports datatypes 'text' and 'date', with all other values defaulting to text. Date will show a datepicker control. Those implementing reporting on a site module may of course extend this to support whatever datatypes they wish to allow, and further types such as geometry and lookup lists are likely to be implemented within the core module - obviously lookup lists may require an extension of the report format, which will be documented as and when.

{{{
      <columns>
            <column name="survey" display="Survey Name" style="color: #ff0000;"/>
            <column name="website" display="Website Name" />
            <column name="count" display="Total no. of Occurrences" />
      </columns>
}}}

Columns are used to give further specification to how particular fields should be displayed. They take three attributes and have no child elements:

  * `name` should match the name used in the query - SELECT foo FROM websites should have name `foo`, SELECT bar AS baz FROM websites should have name `baz` (not `bar`). SELECT w.foo FROM websites should have name `foo`, not `w.foo`, though where there is ambiguity here renaming your columns with 'AS' is the recommended solution. Failing to match this correctly may leave phantom columns in the report.
  * `display` will be displayed as the column header.
  * `style` will be applied to the column (though not the header - obviously implementers of the reporting in a site module may alter this behaviour if they wish).

== Reporting Engine Configuration ==

The reporting engine is included by default in the Indicia core install. Certain configuration settings must be made to allow it to work. Many of these should happen automatically with a fresh install, but users working with existing installations may have to complete them manually.

  # Local Report Directory. A directory for storage of local reports must be defined in the indicia.php config file. A default setting is stored in indicia_dist.php and will default to 'reports'.
  # Read-only database user. It is strongly recommended that a second database user is configured for the reporting services with read-only permissions (ability to execute only SELECT statements). This will prevent any use of the open SQL query functions in the reporting services to make changes to your database. Further, the report user should not have access to the websites, users, people, users_websites or user_tokens tables. Access to specific information in these tables where it is required should be done with the report_users, report_people, report_users_websites and report_websites views (there should be no need to access anything in user_tokens). Hopefully a future install procedure will configure this automatically.
  # Reporting database configuration. Because we want to access the database using a read-only user for security purposes, we need to define a second database connection in Kohana using our new user. In database.php there should be an entry for $config['report'] - if it does not exist, copy the default entry and change the name. You should configure the username and password properties here to use your new, read-only user. The report services will automatically use this connection.

== Core Module Reporting ==

Currently, the only concrete implementation of the reporting is on the core module, and can be accessed through the 'Entered Data' menu. 