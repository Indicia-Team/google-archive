#summary An overview of the notifications system built into Indicia.

= Alerts in Indicia = 

== Overview == 

Indicia has the facility to alert users when any changes to the data held in the warehouse occur which match certain criteria. This involves the following concepts:

 * *Trigger Templates* are definitions of queries against the database  which are run periodically in order to detect changes. For example a trigger template might identify a new record of a certain species, a comment on a record, or a new user registering on the warehouse. The queries contain parameters, so a template can define a query that detects new records of a species without defining which species to detect.

 * *Triggers* are definitions of the exact search that will be performed to identify information that must be sent out as an alert. They define the trigger template that will be used as well as the parameters required when runing the query.

 * *Subscriptions* are definitions of who want to know about the information generated by a trigger and how often they want to receive updates.

 * *Notifications* are the bits of information sent out to subscribers as a result of triggers firing with associated subscriptions. Notifications can be sent out via an email or an email digest, or they can simply be added to the notifications table in the database in which case they will need to be provided with access to view this table's content, e.g. using a report grid.

== Trigger templates ==

Normally you will select from an existing trigger template (see the next section) rather than create new ones, as defining trigger templates is an advanced task. To create a new trigger template, a file must be created in the *reports/trigger_templates* folder on the warehouse. The file format is the same as a report defined on the warehouse, see [Reporting A description of the report file format used by Indicia] for further information. The only stipulation is that the trigger template report file must have an input parameter called *date*. This parameter is filled in with the date of the last time the trigger was used each time it is run, allowing the query to filter for changes since the last time. See the reports/trigger_templates/text.xml template file for an example.

== Creating triggers ==

Anyone with a login on the Warehouse can define a trigger. The triggers are available from the *Admin -> Triggers & Notifications* menu item. Triggers can either be *public* or they can be only available to the user who created them. The list shown includes all triggers that are marked as public or that were created by the logged in user. To create a trigger:

  # Click New trigger to access the Trigger details screen.
  # Enter the name of your trigger, for example "Detect new records in the demo survey" and a description.
  # Select the trigger template from the drop down to define the query that will be run when the trigger is tested. The template called test is provided for you to try and simply detects any new records in a selected survey. Leave the public checkbox unchecked for now, but this can be used to declare a trigger which multiple users can subscribe to. For now this test trigger will be for us only.

http://indicia.googlecode.com/svn/wiki/screenshots/create_trigger.png

Click the *Next* button. Depending on the trigger template you selected, the next page will ask you for any other input parameters required. In the case of the test template, it will ask you to select the survey which you want to detect new records in. Select the demonstration survey and click *Save*.

http://indicia.googlecode.com/svn/wiki/screenshots/configure_trigger_params.png

== Subscribing to the trigger ==

The triggers you have rights to subscribe to are listed on the Triggers page. Click subscribe in the Task column next to the trigger you want to subscribe to. You can now specify the email digest frequency from the options No emails, Immediate, Daily, Weekly. A subscription can also contain a list of other email recipients the notification email should be cc'ed to. This allows notification emails to go to people who are not warehouse users themselves. The *no emails* option defines that notifications are stored in the *notifications* database table and are not emailed out. In this case they can be viewed either from the home page of the warehouse or by adding a report_grid control to an Indicia powered website which lists notifictions for the current user ID.

http://indicia.googlecode.com/svn/wiki/screenshots/subscribe_to_trigger.png

Click *Save* when done. 

== Running the triggers ==

If you are using a warehouse supplied by another organisation then please ask the administrator of the warehouse to confirm that scheduled tasks are running on the warehouse.

If you are using a warehouse for which you are the administrator, then here is how you set them up. Triggers are not fired immediately each time a record is entered in Indicia, as that would slow down performance during data entry. Instead, a task is scheduled to run on a periodic basis (e.g. once per hour) which sweeps up all the records since the last time it was ran. This is done by setting up an operating system task on the server which simply accesses the URL */index.php/scheduled_task* on your warehouse server. On a Linux Apache server, the best way to do this is using [http://en.wikipedia.org/wiki/Cron Cron] whereas on Windows you may like to consider using the [http://en.wikipedia.org/wiki/Task_Scheduler Task Scheduler]. You can also use your web browser to access this url if required, though this is only really appropriate for development and testing purposes as you would need to do this regularly throughout the day.

When using a scheduler you do not need to launch and kill a browser process as php/kohana can be run from the command line. The command to execute will be in the form: 
{{{
php path/to/file/index.php scheduled_tasks
}}}
You will need to insert your path to the Kohana index.php file, enclosing it in inverted commas if it contains spaces.

== Defining your own trigger templates ==

Trigger templates are exactly the same as XML report files, except they must be placed in the reports/trigger_templates directory. They must have a parameter called date, which filters the output by the date the record being tested was entered or updated. They must also have an output attribute called website_id to allow authorisation to be applied (so people cannot subscribe see to records they are not allowed to see).