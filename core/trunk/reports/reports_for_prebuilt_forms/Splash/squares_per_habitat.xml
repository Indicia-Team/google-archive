<report
    title="Squares Per Habitat"
    description="Return a square if it has a plot that is associated with an sample for the habitat provided in the parameter."
>
  <query website_filter_field="square_w.website_id">
  SELECT #columns#
  FROM locations square
    LEFT JOIN locations_websites square_w on square_w.location_id=square.id AND square_w.deleted=false
    JOIN locations plot on plot.parent_id=square.id AND plot.deleted=false
    JOIN samples samp on samp.location_id = plot.id AND samp.deleted = false
    JOIN sample_attribute_values sampHabVal on sampHabVal.sample_attribute_id=#habitat_attr_id# AND sampHabVal.sample_id=samp.id AND sampHabVal.deleted=false
  WHERE square.deleted=false
    AND sampHabVal.int_value=#habitat#
    AND #website_filter#
  </query>
  <params>
    <param name='habitat' display='Habitat' description='Habitat to report on.' datatype='lookup'
        population_call='report:reports_for_prebuilt_forms/Splash/habitats_for_population_call:id:term'/>
    <param name='habitat_attr_id' display='Habitat Sample Attribute Id' description='Id of the sample attribute that holds the habitat.' datatype='integer'/>
  </params>
  <columns> 
    <column name='id' sql='distinct(square.id)' datatype='integer' visible='false'/>
    <column name='centroid_sref' display='Square' sql="regexp_replace(square.centroid_sref, ',[^ ]', ', ', 'g')" datatype='text' />
    <column name='gn' visible='false' feature_style="graphicName" sql="'square'" />    
    <column name="sc" visible="false" feature_style="strokeColor" sql="'green'" />
    <column name="fc" visible="false" feature_style="fillColor" sql="'green'"/>
    <column name="geom" visible="false" mappable="true" sql="st_astext(coalesce(square.boundary_geom,square.centroid_geom))"/>
  </columns>
</report>