<report
    title="Species Richness Per Habitat"
    description="Return the averga number of species found at each habitat."
>
  <query website_filter_field="su.website_id">
  SELECT #columns#
  FROM terms hab
    JOIN sample_attribute_values sampHabVal on sampHabVal.sample_attribute_id=#habitat_attr_id# AND sampHabVal.deleted=false
    JOIN samples samp on samp.id = sampHabVal.sample_id AND samp.deleted = false
    JOIN surveys su on su.id=samp.survey_id AND su.id=#survey_id# AND su.deleted=false
    JOIN termlists_terms tt on tt.id = sampHabVal.int_value AND tt.term_id=hab.id AND tt.deleted=false
    LEFT JOIN occurrences o on o.sample_id = samp.id AND o.deleted = false
    LEFT JOIN taxa_taxon_lists ttl on ttl.id = o.taxa_taxon_list_id AND ttl.deleted=false
    LEFT JOIN taxa tax on tax.id = ttl.taxon_id AND tax.deleted = false  
  WHERE hab.deleted=false
    AND #website_filter#
  GROUP BY hab.term
  </query>
  <order_bys>
    <order_by>hab.term ASC</order_by>
  </order_bys>
  <params>
    <param name='habitat_attr_id' display='Habitat Sample Attribute Id' description='Id of the sample attribute that holds the habitat.' datatype='integer'/>
    <param name='survey_id' display='Survey ID' description='Survey' datatype='lookup' query='SELECT id, title as caption FROM surveys' population_call='direct:survey:id:title'/>
  </params>
  <columns> 
    <column name='habitat' display='Habitat' sql='hab.term' datatype='text'/>
    <column name='total_samples' display='Total Samples Recorded With This Habitat' sql='count(distinct(samp.id))' datatype='float'/>
    <column name='total_species_richness' display='Total Species Richness' sql='count(distinct(tax.id))' datatype='float'/>
    <column name='mean_species_richness' display='Mean Species Richness' sql='cast(count(distinct(tax.id)) as float) / count(distinct(samp.id))'/>
  </columns>
</report>