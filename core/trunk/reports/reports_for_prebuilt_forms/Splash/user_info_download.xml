<report
    title="User Information Download"
    description="Report containing user and person information for download purposes. Includes filter to include only users with/without allocations."
>
  <query website_filter_field="uw.website_id">
  SELECT #columns#
  FROM people p
  JOIN users u ON u.person_id=p.id AND u.deleted=false
  JOIN users_websites uw on u.id=uw.user_id
  LEFT JOIN person_attribute_values pavAlloc ON pavAlloc.person_id=p.id AND pavAlloc.person_attribute_id=#user_square_attr_id# AND pavAlloc.deleted=false 
  LEFT JOIN person_attribute_values pavAddr ON pavAddr.person_id=p.id AND pavAddr.person_attribute_id=#address_attr_id# AND pavAddr.deleted=false 
  LEFT JOIN person_attribute_values pavTown ON pavTown.person_id=p.id AND pavTown.person_attribute_id=#town_attr_id# AND pavTown.deleted=false 
  LEFT JOIN person_attribute_values pavCounty ON pavCounty.person_id=p.id AND pavCounty.person_attribute_id=#county_attr_id# AND pavCounty.deleted=false 
  LEFT JOIN person_attribute_values pavCountry ON pavCountry.person_id=p.id AND pavCountry.person_attribute_id=#country_attr_id# AND pavCountry.deleted=false 
  LEFT JOIN person_attribute_values pavPC ON pavPC.person_id=p.id AND pavPC.person_attribute_id=#post_code_attr_id# AND pavPC.deleted=false 
  LEFT JOIN person_attribute_values pav18 ON pav18.person_id=p.id AND pav18.person_attribute_id=#over_18_attr_id# AND pav18.deleted=false 
  LEFT JOIN locations l ON l.id=pavAlloc.int_value AND l.deleted=false 
  WHERE p.deleted=false
    AND #website_filter#
  </query>
  <order_bys>
    <order_by>p.surname ASC</order_by>
  </order_bys>
  <params>
    <param name='allocation_status' display='Allocated?' description='Choose whether you only wish to return users with allocated squares, without allocated squares, or leave as Please Select for both.' emptyvalue='' datatype='lookup'
        lookup_values='allocated:Allocated,unallocated:Unallocated' >
      <where>(('#allocation_status#'='allocated' AND pavAlloc.id IS NOT NULL) OR ('#allocation_status#'='unallocated' AND pavAlloc.id IS NULL))</where>
    </param>
    <param name='user_square_attr_id' display='Id of the person attribute that holds user squares' description='' datatype='integer'/>
    <param name="registration_date_start" display="User registered on or after this date" description="Only return users who registered on or after this date." datatype="date" emptyvalue="">
      <where>(uw.created_on &gt;= CAST(COALESCE('#registration_date_start#','1500-01-01') as date))</where>
    </param>  
    <param name="registration_date_end" display="User registered before this date" description="Only return users who registered before this date." datatype="date" emptyvalue="">
      <where>(uw.created_on &lt;= CAST(COALESCE('#registration_date_end#','1500-01-01') as date))</where>
    </param>
    <param name="ignore_square_dates_before" display="Ignore Square Dates Before" description="Ignore any squares created before this date.
        Useful if old squares are left on the system but are not currently active." datatype="date" emptyvalue="" default="">
      <where>(l.created_on &gt;= CAST(COALESCE('#ignore_square_dates_before#','1500-01-01') as date))</where>
    </param>
    <param name="address_attr_id" display="Address attribute id" description="Person attribute id that holds the user address." datatype="text"/>
    <param name="town_attr_id" display="Town attribute id" description="Person attribute id that holds the user town." datatype="text"/>
    <param name="county_attr_id" display="County attribute id" description="Person attribute id that holds the user county." datatype="text"/>
    <param name="country_attr_id" display="Country attribute id" description="Person attribute id that holds the user country." datatype="text"/>
    <param name="post_code_attr_id" display="Post code attribute id" description="Person attribute id that holds the user post code." datatype="text"/>
    <param name="over_18_attr_id" display="Over 18 attribute id" description="Person attribute id that holds whether a user is over 18." datatype="text"/>
  </params>
  <columns> 
    <column name='id' sql='u.id' display='Indicia User Id' datatype='integer' in_count="true"/>
    <column name='first_name' display='First name' sql='p.first_name' datatype='text' /> 
    <column name='surname' display='Surname' sql='p.surname' datatype='text' />        
    <column name='username' display='Indicia Username' sql='u.username' datatype='text'/> 
    <column name='email_address' display='Email address' sql='p.email_address' datatype='text' />  
    <column name='address' display='Address' sql='pavAddr.text_value' datatype='text' />
    <column name='town' display='Town' sql='pavTown.text_value' datatype='text' />
    <column name='county' display='County' sql='pavCounty.text_value' datatype='text' />
    <column name='country' display='Country' sql='pavCountry.text_value' datatype='text' />
    <column name='post_code' display='Post Code' sql='pavPC.text_value' datatype='text' />
    <column name='over_18' display='Over 18?' sql="case pav18.text_value when '1' then 'Yes' else 'No' End" datatype='text' />
    <column name='registration_date' display='Registration date' sql='uw.created_on' datatype='text' />  
    <column name='count' sql='count(distinct(pavAlloc.id))' display='Number of allocated squares' datatype='integer' aggregate="true"/>
    <column name='allocated_squares' sql="string_agg(l.name, ',')" display='Squares allocated' datatype='text' aggregate="true"/>
  </columns>
</report>