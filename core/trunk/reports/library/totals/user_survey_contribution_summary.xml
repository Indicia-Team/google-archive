<?xml version="1.0" encoding="UTF-8"?>
<report title="User survey contribution summary" description="A breakdown of totals describing a user's contribution within the context of a survey.">
  <query website_filter_field="o.website_id">
    select 1 as sort, 'My records for survey' as qualifier, count(distinct o.id) as value
    from cache_occurrences o
    where #website_filter#
    and o.created_by_id=#user_id#
    and o.survey_id=#survey_id#

    union

    select 2, 'My species for survey' as qualifier, count(distinct case o.zero_abundance when true then null else o.taxa_taxon_list_external_key end)
    from cache_occurrences o
    where #website_filter#
    and o.created_by_id=#user_id#
    and o.survey_id=#survey_id#

    union

    select 3, 'My verified records for survey' as qualifier, count(distinct o.id)
    from cache_occurrences o
    where #website_filter#
    and o.created_by_id=#user_id# 
    and o.survey_id=#survey_id#
    and o.record_status='V'
    
    union
    
    select 4, 'league position' as qualifier, value from (
      select o.created_by_id, row_number() over (order by count(DISTINCT CASE o.zero_abundance WHEN true THEN NULL ELSE o.taxa_taxon_list_external_key END) desc) as value
      from cache_occurrences o
      where #website_filter#
      and o.survey_id=#survey_id#
      group by o.created_by_id
    ) as sub
    where created_by_id=#user_id#   

    union 

    select 5, 'All records for survey', count(distinct o.id) 
    from cache_occurrences o
    where #website_filter#
    and o.survey_id=#survey_id#

    union

    select 6, 'My records for iRecord', count(distinct o.id)
    from cache_occurrences o
    where #website_filter#
    and o.created_by_id=#user_id#
  </query>
  <order_bys>
    <order_by>sort ASC</order_by>
  </order_bys>  
  <params>
    <param name='user_id' display='Warehouse user ID' datatype='integer' />
    <param name='survey_id' display='Survey ID' datatype='integer' />
  </params>
</report>