  <report
    title="Locations with geometry for location type"
    description="List of locations (with geometry) for a given location type whose parent matches the given parent id."
>
  <query website_filter_field="lw.website_id">
    SELECT #columns# 
    FROM locations l
      LEFT JOIN locations_websites lw ON lw.location_id=l.id 
      JOIN termlists_terms tt ON tt.id = l.location_type_id
      JOIN terms t ON t.id = tt.term_id
      LEFT JOIN locations lLatestChild on lLatestChild.created_on in (select max(created_on) from locations where parent_id=l.id)
      LEFT JOIN location_attribute_values lLAV on lLAV.location_id = l.id and lLAV.location_attribute_id = #preferred_boundary_attribute_id#   
      LEFT JOIN locations lcub on lcub.id = COALESCE(lLAV.int_value, lLatestChild.id) and lcub.location_type_id=#count_unit_boundary_type_id#
      #joins#
    WHERE 1=1
      #filters#
      AND #website_filter# AND l.deleted = false
      AND lw.deleted = false AND tt.deleted = false
      AND t.deleted = false
  </query>
  <params>
    <param name="location_type_id" datatype="integer">
      <where>l.location_type_id in (#location_type_id#)</where>
    </param>
    <param name="parent_id" datatype="integer">
      <join>JOIN locations lp on st_intersects(lp.boundary_geom, l.centroid_geom) and lp.id=#parent_id#</join>
    </param>
    <param name="preferred_boundary_attribute_id" datatype="integer"/>
    <param name="count_unit_boundary_type_id" datatype="integer"/>
  </params>
  <columns>
    <column name="id" sql="l.id"/>
    <column name="name" sql="l.name"/>
    <column name="location_type_name" sql="t.term"/>
    <column name="boundary_geom" sql="st_astext(COALESCE(l.boundary_geom, lcub.boundary_geom))" mappable="true"/>
    <column name="centroid_geom" sql="st_astext(st_centroid(l.centroid_geom))" mappable="true"/>
    <column name="graphic" sql="case when st_astext(l.boundary_geom) is  not null then 'circle' else 'cross' end" mappable="true"/>
  </columns>
</report>
