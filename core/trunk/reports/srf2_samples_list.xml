<report
    title="Samples in Survey"
    description="Lists the top level samples in a specified survey."
>
  <query>
  SELECT s.id,
  		l.name as location_name,
  		s.date_start,
  		s.date_end,
  		s.date_type,
  		(select int_value from sample_attribute_values sav
  			where sav.sample_id = s.id and sav.deleted = FALSE and sav.sample_attribute_id = #visit_id#) as num_visit,
  		(select count(*) from samples cs where cs.parent_id = s.id and cs.deleted = FALSE) as num_occurrences,
  		(select count(distinct o.taxa_taxon_list_id)
  			from samples cs, occurrences o
  			where cs.parent_id = s.id and cs.deleted = FALSE
  				AND o.sample_id = cs.id and o.deleted = FALSE) as num_taxa,
  		(select int_value from sample_attribute_values sav
  			where sav.sample_id = s.id and sav.deleted = FALSE and sav.sample_attribute_id = #closed_id#) as closed
  FROM samples s
  LEFT JOIN locations l ON l.id=s.location_id
  WHERE s.survey_id=#survey# AND s.deleted = FALSE AND s.parent_id is null
  #order_by#
  </query>
  <order_bys>
    <order_by>date_start DESC</order_by>
  </order_bys>
  <params>
    <param name='survey' display='Survey: ' description='Select the survey to return data for?' datatype='lookup'
        query='SELECT id, title as caption FROM surveys' />
    <param name='visit_id' display='Visit ID: ' description='ID of sample_attribute for visit' datatype='int' />
    <param name='closed_id' display='Closed ID: ' description='ID of sample_attribute for closure' datatype='int' />
  </params>
  <columns>
    <column name='id' display='ID' />
    <column name='location_name' display='Transact' />
    <column name='date' display='Date' />
    <column name='num_visit' display='Visit Number' />
    <column name='num_occurrences' display='# Occurrences' />
    <column name='num_taxa' display='# Species' />
  </columns>
</report>
